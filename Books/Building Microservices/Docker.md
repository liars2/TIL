도커
=========

    이 글은 도커에 대한 간단한 설명, 도커가 필요한 이유 그리고 도커를 사용했을 때의 장점과 간단한 사용방법에 대해 설명합니다.

서버 설치하는데만 30년
----------------------

    새로운 서버에 세팅하기 위해 처음부터 끝까지 기존 설정을 옮긴다고 하였을 때,
    OS를 설치하고, 의존성 체크 하고 여러 개의 프로그램 중 지원하고 혹은 지원하지 않는 것, 라이브러리 충돌..
    자원이 낭비되어도 차라리 다른 조립 PC에서 사용하는 게 더 나을 정도인 환경을 구상하는 것도 인력 낭비다.

    또 DevOps 혹은 SRE의 발전으로 빠른 배포 주기, 그리고 마이크로서비스 아키텍처로 서비스를 배포한다면 서비스 하나당 서버 설정.. 평생 서버만 구성해야 하는가?

도커의 등장
------------

[Pycon 2013에서 세상에 모습을 들어낸 도커는](https://www.youtube.com/watch?v=wW9CAH9nSLs), 이미지들을 사용해 컨테이너를 만들고 해당 컨테이너에서 간단한 echo 동작을 했을때 컨테이너에서 개별작동하는 것을 볼 수 있습니다.

**세상에 이미지 하나로 컨테이너를 만들고, 프로비저닝을 관리하고, 네트워킹 문제를 처리하고, 애플리케이션 버전관리를 할 수 있게 레지스트리 개념까지도 지원한다고?**

도커란?
-------

    이미지로 컨테이너를 만들어 원하는 서비스를 돌린다.. 이 용어를 이해하려면 컨테이너라는 단어로 정의한 이유를 알아야한다.

### 컨테이너

<img src="https://qz.com/wp-content/uploads/2017/01/maersk-alibaba-e-commerce-e1483555932502.jpg">

*각기 다른 물품들이 채워진 컨테이너들을 싣고가는 큰 배*

우리가 컨테이너 라고 생각하면, 이런 큰 배에 있는 컨테이너들 부터 먼저 생각이 날 것입니다.

도커의 컨테이너는 격리된 공간에서 프로세스가 동작하는 기술인데, OS를 가상화 해서 서비스를 운영하는 기존 방식과는 조금 다릅니다.

기존에는 VM에서 OS를 설치해 VM마다 OS와 가상화 프로그램등의 부하가 생겼는데, 컨테이너는 격리된 프로세스에서 서비스를 운영합니다.

각기 다른 서비스의 필요한 프로그램, 실행환경만 필요로 하여 컨테이너로 추상화해 쉽게 배포 및 관리를 할 수 있도록 해줍니다.

<img src="https://subicura.com/assets/article_images/2017-01-19-docker-guide-for-beginners-1/vm-vs-docker.png">

*VM과 Docker의 비교*

도커의 컨테이너는 구격화되어 조립 PC, AWS, Google Cloud등 사용할 수 있습니다.

### 이미지

    서비스의 필요한 코드, 런타임 프로그램, 시스템 툴들, 시스템 라이브러리, 세팅.. 들을 한 번에 묶은 것이다.
    이미지 하나만 있으면 Ctrl + C, V 으로 쉽게 여러 서버스를 올릴 수 있다!

### 앗 '그것' 빠트렸다

    서비스의 필요한 코드, 런타임.. 전부 설치하고 이미지를 만들었다.
    이제 서비스 배포하려고 하는데. 아차차.. 하나를 빼먹었다 다시 이미지를 만들어야 하는가???

도커는 이런 문제를 해결하기 위해서 레이어 라는 개념을 도입하였는데, 유니온 파일 시스템을 이용해서 여러개의 레이어를 하나의 파일시스템으로 사용할 수 있게 해준다.

#### 레이어에 대한 이해

    위에 말한 유니온 파일 시스템을 이해하고, 도커의 레이어에 대입하기 위해서는 이와 같은 지식들을 알아야한다.

##### Boot File System

    부트로더와 커널이 있는 장소, User들은 이 곳을 건드릴 수 없다.
    부팅 과정이 끝난 직후 커널 전체가 메모리에 있고, initrd와 연결된 RAM의 정보를 마운트 초기화 하고 언마운트 한다.

[initrd](http://croky.tistory.com/entry/%EC%B4%88%EA%B8%B0-RAM-%EB%94%94%EC%8A%A4%ED%81%AC-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-initrd)

##### Root File System

    유닉스 기반 OS와 관련있는 디렉토리 구조(/etc, /tmp, /dev, /bin.. etc..)와 유저 설정 정보, 바이너리등을 가지고 있다.

##### Union File System

    기본적인 Unix 운영체제의 부팅 과정은 OS 커널이 Root file system을 read-only로 읽은 후, 이상이 없나 유효성 검사를 한 뒤에, read + write 권한으로 부트로더와 커널을 건드린다.

하지만, Docker가 rootfs를 마운트 할떄, 유니온 파일 시스템을 사용하는데. 유니온 파일 시스템은 한 디렉토리에 여러개의 파일 시스템을 추가할 수 있는 기술이다.

그렇다면, 마운트 할때의 과정은 어떻게 되는가?

리눅스의 부팅 과정처럼 read-only로 마운트 되지만, read-write 모드로 전환하는 것 대에 read-only 파일 시스템 위에 read-write 파일시스템을 추가하여 union mount를 활용한다.

그렇게 된다면, 여러개의 read-only 파일시스템이 있을 수 있으며, 도커는 이들의 파일시스템들을 layer로써 생각을 합니다.

<img src="https://subicura.com/assets/article_images/2017-01-19-docker-guide-for-beginners-1/image-layer.png">

### 격리되어 있는 프로세스

위 설명대로라면, 프로세스를 격리시킬 수 있다고 하는데. 그런 기능이 어디서 존재할 수 있는가?

레드햇 리눅스 6 버전에서는 컨트롤 그룹이라는 새로운 커널 기능을 제공한다. 이 기능으로 격리된 프로세스를 만들 수 있는데 자세한 설명은 밑에 있다.

#### 컨트롤 그룹

Control group을 통해서 CPU 시간, 시스템 메모리, 네트워크 대역폭 같은 자원이나 조합을 시스템에서 실행 중인 프로세스 간에 할당 할 수 있습니다.

#### 네임스페이스

컨테이너마다 다른 유저와(uid) 그룹이(gid) 존재할 수 있습니다!
이게 무슨말이냐면 컨테이너 안에 있는 Root권한을 효율적으로 제어할 수 있습니다.





참고 자료
--------
https://www.youtube.com/watch?v=wW9CAH9nSLs&feature=youtu.beㅇ

https://subicura.com/2017/01/19/docker-guide-for-beginners-1.html

https://www.docker.com/what-container

http://docs.docker.io/en/latest/terms/layer/
